# ===========================================
# AI-Manager CMS - Caddyfile
# ===========================================
# Configuration automatique selon .env :
#
# Mode 1 - Derrière CWP/Apache (SSL géré par le proxy) :
#   SITE_ADDRESS=:80
#   → Caddy écoute sur le port 80, pas de SSL
#
# Mode 2 - Serveur dédié avec SSL Let's Encrypt :
#   SITE_ADDRESS=ai.mondomaine.com
#   ACME_EMAIL=admin@mondomaine.com
#   → Caddy gère SSL automatiquement
#
# Mode 3 - Développement local :
#   SITE_ADDRESS=localhost
#   → Certificat auto-signé automatique
# ===========================================

# Configuration globale
{
    # Email pour Let's Encrypt (requis pour les domaines réels)
    email {$ACME_EMAIL:}

    # Logs
    log {
        level INFO
        format console
    }
}

# Site principal - configuré via SITE_ADDRESS dans .env
# Exemples : :80, localhost, ai.mondomaine.com
{$SITE_ADDRESS::80} {
    # Racine du site Laravel
    root * /var/www/html/public

    # Compression
    encode gzip zstd

    # Logs d'accès
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
    }

    # Headers de sécurité
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # Assets statiques avec cache long
    @static {
        path *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Routes nécessitant un timeout étendu (Livewire, API IA)
    @longrunning {
        path /livewire/*
        path /admin/*
        path /api/chat/*
    }

    # PHP-FPM pour requêtes longues (timeout 10 minutes)
    handle @longrunning {
        php_fastcgi app:9000 {
            resolve_root_symlink
            trusted_proxies private_ranges
            dial_timeout 10s
            read_timeout 600s
            write_timeout 600s
        }
    }

    # PHP-FPM standard (timeout 2 minutes)
    php_fastcgi app:9000 {
        resolve_root_symlink
        trusted_proxies private_ranges
        dial_timeout 5s
        read_timeout 120s
        write_timeout 120s
    }

    # Fichiers statiques
    file_server

    # Fallback Laravel (toutes les routes vers index.php)
    try_files {path} {path}/ /index.php?{query}
}
